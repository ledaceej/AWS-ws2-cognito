---
title : "Viết API"
date : "`r Sys.Date()`"
weight : 1
chapter : false
pre : " <b> 8.2.1 </b> "
---

## Viết API
1. Tạo model class

- Mở **Passenger.java** dán đoạn code sau đây
```
package com.airlines.catalog.model;
import lombok.Getter;
import lombok.Setter;
import lombok.NoArgsConstructor;
import lombok.experimental.Accessors;
import javax.persistence.*;
import javax.persistence.GenerationType;

/* Build a Passenger Entity class with columns passengerId as Identity auto generated, adult, gender, firstName,
lastName mapped to passenger table, column names sepetated by _*/
@Getter
@Setter
@NoArgsConstructor
@Accessors(chain = true)
@Entity
@Table(name = "passenger")
public class Passenger {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "passenger_id")
    private int passengerId;
    @Column(name = "adult")
    private boolean adult;
    @Column(name = "gender")
    private String gender;
    @Column(name = "first_name")
    private String firstName;
    @Column(name = "last_name")
    private String lastName;
    //Create a tostring method to convert the object to string
    @Override
    public String toString() {
        return "Passenger{" +
                "passengerId=" + passengerId +
                ", adult=" + adult +
                ", gender='" + gender + '\'' +
                ", firstName='" + firstName + '\'' +
                ", lastName='" + lastName + '\'' +
                '}';
    }

    public int getPassengerId() {
        return passengerId;
    }

    public void setPassengerId(int passengerId) {
        this.passengerId = passengerId;
    }

    public boolean isAdult() {
        return adult;
    }

    public void setAdult(boolean adult) {
        this.adult = adult;
    }

    public String getGender() {
        return gender;
    }

    public void setGender(String gender) {
        this.gender = gender;
    }

    public String getFirstName() {
        return firstName;
    }

    public void setFirstName(String firstName) {
        this.firstName = firstName;
    }

    public String getLastName() {
        return lastName;
    }

    public void setLastName(String lastName) {
        this.lastName = lastName;
    }

    //Create a toJson method to convert the object to Json String
    public String toJson() {
        return "{" +
                "\"passengerId\":" + passengerId +
                ", \"adult\":" + adult +
                ", \"gender\":\"" + gender + '\"' +
                ", \"firstName\":\"" + firstName + '\"' +
                ", \"lastName\":\"" + lastName + '\"' +
                '}';
    }
}
```
- Mở **Reservation.java** dán đoạn code sau đây
```
package com.airlines.catalog.model;

import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;
import lombok.experimental.Accessors;
import javax.persistence.*;

/* Build a Reservation Entity class  mapped to database table reservation
  Attributes for the class:
  bookingReference as long identity autogenerated,
  passengerId, flightId, reservationDate, reservationTime,reservationStatus, travelClass,
  ticketPrice as double, currencyCode, paymentStatus, paymentMode, contactNumber,
  contactEmail mapped to column names seperated by _ */
@Getter
@Setter
@NoArgsConstructor
@Accessors(chain = true)
@Entity
@Table(name = "reservation")
public class Reservation {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "booking_reference")
    private long bookingReference;
    @Column(name = "passenger_id")
    private int passengerId;
    @Column(name = "flight_id")
    private int flightId;
    @Column(name = "reservation_date")
    private String reservationDate;
    @Column(name = "reservation_time")
    private String reservationTime;
    @Column(name = "reservation_status")
    private String reservationStatus;
    @Column(name = "travel_class")
    private String travelClass;
    @Column(name = "ticket_price")
    private double ticketPrice;
    @Column(name = "currency_code")
    private String currencyCode;
    @Column(name = "payment_status")
    private String paymentStatus;
    @Column(name = "payment_mode")
    private String paymentMode;
    @Column(name = "contact_number")
    private String contactNumber;
    @Column(name = "contact_email")
    private String contactEmail;

    //Create a tostring method to convert the object to string
    @Override
    public String toString() {
        return "Reservation{" +
                "bookingReference=" + bookingReference +
                ", passengerId=" + passengerId +
                ", flightId=" + flightId +
                ", reservationDate='" + reservationDate + '\'' +
                ", reservationTime='" + reservationTime + '\'' +
                ", reservationStatus='" + reservationStatus + '\'' +
                ", travelClass='" + travelClass + '\'' +
                ", ticketPrice=" + ticketPrice +
                ", currencyCode='" + currencyCode + '\'' +
                ", paymentStatus='" + paymentStatus + '\'' +
                ", paymentMode='" + paymentMode + '\'' +
                ", contactNumber='" + contactNumber + '\'' +
                ", contactEmail='" + contactEmail + '\'' +
                '}';
    }
    //Create a toJson method to convert the object to Json String
    public String toJson() {
        return "{" +
                "\"bookingReference\":" + bookingReference +
                ", \"passengerId\":" + passengerId +
                ", \"flightId\":" + flightId +
                ", \"reservationDate\":\"" + reservationDate + '\"' +
                ", \"reservationTime\":\"" + reservationTime + '\"' +
                ", \"reservationStatus\":\"" + reservationStatus + '\"' +
                ", \"travelClass\":\"" + travelClass + '\"' +
                ", \"ticketPrice\":" + ticketPrice +
                ", \"currencyCode\":\"" + currencyCode + '\"' +
                ", \"paymentStatus\":\"" + paymentStatus + '\"' +
                ", \"paymentMode\":\"" + paymentMode + '\"' +
                ", \"contactNumber\":\"" + contactNumber + '\"' +
                ", \"contactEmail\":\"" + contactEmail + '\"' +
                '}';
    }

    public long getBookingReference() {
        return bookingReference;
    }

    public void setBookingReference(long bookingReference) {
        this.bookingReference = bookingReference;
    }

    public int getPassengerId() {
        return passengerId;
    }

    public void setPassengerId(int passengerId) {
        this.passengerId = passengerId;
    }

    public int getFlightId() {
        return flightId;
    }

    public void setFlightId(int flightId) {
        this.flightId = flightId;
    }

    public String getReservationDate() {
        return reservationDate;
    }

    public void setReservationDate(String reservationDate) {
        this.reservationDate = reservationDate;
    }

    public String getReservationTime() {
        return reservationTime;
    }

    public void setReservationTime(String reservationTime) {
        this.reservationTime = reservationTime;
    }

    public String getReservationStatus() {
        return reservationStatus;
    }

    public void setReservationStatus(String reservationStatus) {
        this.reservationStatus = reservationStatus;
    }

    public String getTravelClass() {
        return travelClass;
    }

    public void setTravelClass(String travelClass) {
        this.travelClass = travelClass;
    }

    public double getTicketPrice() {
        return ticketPrice;
    }

    public void setTicketPrice(double ticketPrice) {
        this.ticketPrice = ticketPrice;
    }

    public String getCurrencyCode() {
        return currencyCode;
    }

    public void setCurrencyCode(String currencyCode) {
        this.currencyCode = currencyCode;
    }

    public String getPaymentStatus() {
        return paymentStatus;
    }

    public void setPaymentStatus(String paymentStatus) {
        this.paymentStatus = paymentStatus;
    }

    public String getPaymentMode() {
        return paymentMode;
    }

    public void setPaymentMode(String paymentMode) {
        this.paymentMode = paymentMode;
    }

    public String getContactNumber() {
        return contactNumber;
    }

    public void setContactNumber(String contactNumber) {
        this.contactNumber = contactNumber;
    }

    public String getContactEmail() {
        return contactEmail;
    }

    public void setContactEmail(String contactEmail) {
        this.contactEmail = contactEmail;
    }
}
```
2. Tạo một ReservationDetails DTO class sẽ được dùng để kiểm tra tất cả và giữ tham số đầu vào được cung cấp tới API đặt chuyến bay. 
- Mở **ReservationDetails.java** dán đoạn code sau đây
```
package com.airlines.catalog.dto;

import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;
import lombok.experimental.Accessors;
import javax.validation.constraints.*;

/* Create a class ReservationDetails with attributes
firstName not blank, lastName not blank,
gender, age between 1 and 120, flightId as int, travelClass not blank,
ticketPrice as double and not blank,
currencyCode exactly  3 characters, reservationStatus,  paymentStatus,
paymentMode,  ContactEmail should be valid email, contactNumber should be valid phone number
*/
@Getter
@Setter
@NoArgsConstructor
@Accessors(chain = true)
public class ReservationDetails {
    @NotBlank(message = "First Name is required")
    private String firstName;
    @NotBlank(message = "Last Name is required")
    private String lastName;
    private String gender;
    @Min(value = 1, message = "Age should be greater than 1")
    @Max(value = 120, message = "Age should be less than 120")
    private int age;
    @NotNull(message = "Flight Id is required")
    private int flightId;
    @NotBlank(message = "Travel Class is required")
    private String travelClass;
    @NotNull(message = "Ticket Price is required")
    private double ticketPrice;
    @NotBlank(message = "Currency Code is required")
    @Pattern(regexp = "^[A-Z]{3}$", message = "Currency Code should be exactly 3 characters")
    private String currencyCode;
    private String reservationStatus;
    private String paymentStatus;
    private String paymentMode;
    @Email(message = "Contact Email should be valid email")
    private String contactEmail;
    // Phone Number should be 12 or more digits and starts with +
    @Pattern(regexp = "^\\+[0-9]{12,}$", message = "Contact Number should be valid phone number")
    private String contactNumber;

    public String getFirstName() {
        return firstName;
    }

    public void setFirstName(String firstName) {
        this.firstName = firstName;
    }

    public String getLastName() {
        return lastName;
    }

    public void setLastName(String lastName) {
        this.lastName = lastName;
    }

    public String getGender() {
        return gender;
    }

    public void setGender(String gender) {
        this.gender = gender;
    }

    public int getAge() {
        return age;
    }

    public void setAge(int age) {
        this.age = age;
    }

    public int getFlightId() {
        return flightId;
    }

    public void setFlightId(int flightId) {
        this.flightId = flightId;
    }

    public String getTravelClass() {
        return travelClass;
    }

    public void setTravelClass(String travelClass) {
        this.travelClass = travelClass;
    }

    public double getTicketPrice() {
        return ticketPrice;
    }

    public void setTicketPrice(double ticketPrice) {
        this.ticketPrice = ticketPrice;
    }

    public String getCurrencyCode() {
        return currencyCode;
    }

    public void setCurrencyCode(String currencyCode) {
        this.currencyCode = currencyCode;
    }

    public String getReservationStatus() {
        return reservationStatus;
    }

    public void setReservationStatus(String reservationStatus) {
        this.reservationStatus = reservationStatus;
    }

    public String getPaymentStatus() {
        return paymentStatus;
    }

    public void setPaymentStatus(String paymentStatus) {
        this.paymentStatus = paymentStatus;
    }

    public String getPaymentMode() {
        return paymentMode;
    }

    public void setPaymentMode(String paymentMode) {
        this.paymentMode = paymentMode;
    }

    public String getContactEmail() {
        return contactEmail;
    }

    public void setContactEmail(String contactEmail) {
        this.contactEmail = contactEmail;
    }

    public String getContactNumber() {
        return contactNumber;
    }

    public void setContactNumber(String contactNumber) {
        this.contactNumber = contactNumber;
    }
}
```
3. Dựng JPA Repository Interfaces để truy cập dữ liệu từ bảng trong MYSQL. Chỉ định mẫu câu truy vấn để lưu dữ liệu tới bảng passenger và reservation.
- Mở **PassengerRepository.java** dán đoạn code sau đây
```
package com.airlines.catalog.repository;

import com.airlines.catalog.model.Passenger;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;


/* create jpa repository interface PassengerRepository.
Add a method to save Passenger. */
@Repository
public interface PassengerRepository extends JpaRepository<Passenger, Integer> {
    Passenger save(Passenger passenger);
}
```
- Mở **ReservationRepository.java** dán đoạn code sau đây
```
package com.airlines.catalog.repository;

import com.airlines.catalog.model.Reservation;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

// Create interface ReservationRepository that extends JpaRepository.
// Add a method to save reservation.
@Repository
public interface ReservationRepository extends JpaRepository<Reservation, Long> {

    Reservation save(Reservation reservation);
}
```
4. Tạo exception handler classes để xử lý các nghiệp vụ: Invalid data inputs to the reservation API, invalid flight Id and no seats available in the flight.
- Mở **FlightNotFoundException.java** dán đoạn code sau đây
```
package com.airlines.catalog.exception;

import lombok.NoArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import lombok.Getter;
/*
Create a public class FlightNotFoundException that extends Runtime Exception with member variable
response entity.
Create constructor with flightId as input parameter
Exception message returned should be "No flights found for the flight id " and append flight id
*/
@Getter
public class FlightNotFoundException extends RuntimeException {
    private ResponseEntity<String> responseEntity;

    public FlightNotFoundException(long flightId) {
        responseEntity = new ResponseEntity<>("No flights found for the flight id " + flightId, HttpStatus.NOT_FOUND);
    }
}
```
- Mở **RequestedSeatsNotAvailable.java** dán đoạn code sau đây
```
package com.airlines.catalog.exception;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import lombok.Getter;
import lombok.Setter;
import lombok.experimental.Accessors;
/*
Create a public class RequestedSeatsNotAvailable that extends Runtime Exception with member variable
response entity, constructor has no arguments
exception message returned should be "Seats not available. Reservation could not be made"
*/
@Getter
public class RequestedSeatsNotAvailable extends RuntimeException {
    private ResponseEntity<String> responseEntity;

    public RequestedSeatsNotAvailable() {
        responseEntity = new ResponseEntity<>("Seats not available. Reservation could not be made", HttpStatus.NOT_FOUND);
    }
}
```
- Mở **GlobalExceptionHandler.java** dán đoạn code sau đây
```
package com.airlines.catalog.exception;

import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.validation.FieldError;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

/*create a rest controller advice GlobalExceptionHandler*/
@RestControllerAdvice
public class GlobalExceptionHandler {
    //create exception handler handleValidationErrors to handle validation errors
    // get all the errors from exception
    // get the  errors and add them to the map
    // create a new response entity
    // return the response entity
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<Map<String, String>> handleValidationErrors(MethodArgumentNotValidException ex) {
        Map<String, String> errors = new HashMap<>();
        List<FieldError> fieldErrors = ex.getBindingResult().getFieldErrors();
        fieldErrors.forEach(error -> errors.put(error.getField(), error.getDefaultMessage()));
        return new ResponseEntity<>(errors, HttpStatus.BAD_REQUEST);
    }
}
```
5. Build the FlightBooking service class that creates a new database transaction to save the passenger, reservation data into respective tables and also send an SNS notification to reservation-success topic. An email notification will be sent to the configured email address. This method will also check for seat availability before proceeding with the reservation and throw an business exception, if seats are not available.
- Mở **FlightBooking.java** dán đoạn code sau đây
```
package com.airlines.catalog.service;

import com.airlines.catalog.exception.FlightNotFoundException;
import com.airlines.catalog.exception.RequestedSeatsNotAvailable;
import com.airlines.catalog.model.Flight;
import com.airlines.catalog.model.Passenger;
import com.airlines.catalog.model.Reservation;
import com.airlines.catalog.repository.FlightRepository;
import com.airlines.catalog.repository.PassengerRepository;
import com.airlines.catalog.repository.ReservationRepository;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;
import software.amazon.awssdk.regions.Region;
import software.amazon.awssdk.services.sns.SnsClient;
import software.amazon.awssdk.services.sns.model.PublishRequest;
import software.amazon.awssdk.services.sns.model.PublishResponse;

@Service
public class FlightBooking {

    /* create a method send message with sns arn and AWS Region as input parameter*/
    public void sendMessage(String message, String arn, Region region) {
        SnsClient snsClient = SnsClient.builder()
                .region(region)
                .build();

        PublishRequest request = PublishRequest.builder()
                .message(message)
                .topicArn(arn)
                .build();

        PublishResponse result = snsClient.publish(request);
        System.out.println(result.messageId() + " Message sent. Status is " + result.sdkHttpResponse().statusCode());
        snsClient.close();


    }

    /*Create reserveFlight method with passenger, reservation, passengerRepository,
reservationRepository,flightresultsRepository, number of passengers as input parameters.
Method should return a Boolean output
Get the flight details by calling findById method from FlightresultsRepository with
flightId as input parameter
if no result is null throw FlightNotFoundException
If number of seats is less than number of passengers throw RequestedSeatsNotAvailable exception with
flightId as input parameter
Call getseatAvailable from flight object to get the available seats
If seats available is less than number of passengers then return false
If seats available is greater than or equal to number of passengers then
    decrease the seats available attribute in flight object by calling setseatAvailable method
    Save the passenger and get the passenger id
    update the reservation object with the passenger id
    save the reservation details
    call sendMessage by passing reservation json string as input parameter
    Method should return True or False based on the result of save methods
All of the above steps should be done within a transaction.
 */
    @Transactional(propagation = Propagation.REQUIRED)
    public Boolean reserveFlight(Passenger passenger, Reservation reservation,
                                 PassengerRepository passengerRepository, ReservationRepository reservationRepository, FlightRepository flightRepository,
                                 int numberOfPassengers, String topicArn, Region region) throws FlightNotFoundException, RequestedSeatsNotAvailable {
        Flight flight = flightRepository.findById(reservation.getFlightId());
        if (flight == null) {
            throw new FlightNotFoundException(reservation.getFlightId());
        }
        if (flight.getSeatAvailable() < numberOfPassengers) {
            throw new RequestedSeatsNotAvailable();
        }
        flight.setSeatAvailable(flight.getSeatAvailable() - numberOfPassengers);
        flightRepository.save(flight);
        Passenger passenger1 = passengerRepository.save(passenger);
        reservation.setPassengerId(passenger1.getPassengerId());
        reservationRepository.save(reservation);
        sendMessage(reservation.toString(), topicArn, region);
        return true;

    }
}
```

8. Tạo the book flight API Controller
- Mở **FlightReservation.java** dán đoạn code sau đây
```
package com.airlines.catalog.controller;

import java.nio.channels.ScatteringByteChannel;
import java.util.List;
import com.airlines.catalog.dto.FlightDetails;
import com.airlines.catalog.exception.AuthenticationException;
import com.airlines.catalog.repository.AirportRepository;
import com.airlines.catalog.repository.FlightRepository;
import com.airlines.catalog.service.FlightDetailsService;
import com.auth0.jwt.JWT;
import com.auth0.jwt.JWTVerifier;
import com.auth0.jwt.algorithms.Algorithm;
import com.auth0.jwt.interfaces.DecodedJWT;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestHeader;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import com.airlines.catalog.repository.PassengerRepository;
import com.airlines.catalog.repository.ReservationRepository;
import com.airlines.catalog.service.FlightBooking;
import com.airlines.catalog.dto.ReservationDetails;
import com.airlines.catalog.exception.FlightNotFoundException;
import com.airlines.catalog.exception.RequestedSeatsNotAvailable;
import com.airlines.catalog.model.Passenger;
import com.airlines.catalog.model.Reservation;
import org.springframework.web.bind.annotation.*;
import software.amazon.awssdk.regions.Region;
import javax.validation.Valid;



@RestController
public class FlightReservation {
    @Autowired
    FlightRepository flightresultsRepository;
    @Autowired
    AirportRepository airportresultsRepository;
    @Autowired
    FlightDetailsService FlightDetailsService;

    @Autowired
    PassengerRepository passengerRepository;
    @Autowired
    ReservationRepository reservationRepository;
    @Autowired
    FlightBooking flightBooking;

    @Value("${cognito.userpool.id}")
    private String cognitoUserPoolId;
    @Value("${aws.region}")
    private String awsRegion;
    @Value("${sns.arn}")
    private String snsTopicArn;

    /* Create a private method verifyToken to verify JWT token with input parameters as
    Cognito user pool id, AWS region and token string. Function returns a Boolean.
    Construct the Cognito well known url and then verify the token using RSA Algorithm.
    catch all Exception throw new authenticationException.*/
    private Boolean verifyToken(String cognitoUserPoolId, String awsRegion, String token) throws AuthenticationException {
        try {
            System.out.println("token=" + token);

            String cognitoWellKnownUrl = "https://"+ cognitoUserPoolId + "/.well-known/jwks.json";
            Algorithm algorithm = Algorithm.RSA256(new AwsCognitoRSAKeyProvider(cognitoWellKnownUrl));
            JWTVerifier verifier = JWT.require(algorithm).build();
            DecodedJWT decodedJWT = verifier.verify(token);
            return true;
        } catch (Exception e) {
            throw new AuthenticationException(e);
        }
    }

    /* Create a rest controller getFlightDetails to get flight details with HTTP GET Method ,
   /flight path and request parameters as departure date, departure airport code and arrival airport code
   JWT Token in the Authorization Header.
   Rest controller returns a ResponseEntity of string.
   */
    @GetMapping("/flight")
    public ResponseEntity<String> getFlightDetails(@RequestParam("departureDate") String departureDate,
                                                   @RequestParam("departureAirportCode") String departureAirportCode,
                                                   @RequestParam("arrivalAirportCode") String arrivalAirportCode,
                                                   @RequestHeader("Authorization") String authorization) throws AuthenticationException {
        /* Call verifyToken method, catch authentication exception and return the responseEntity
    if token is valid and call the findFlights method in FlightDetailsService class
    with input parameters  departure date, departure airport code,
    arrival airport code, flightResultsRepository and airportResultsRepository.
    If flights are found return the list of flights otherwise return "No flights found".
    If authentication failed the return "Authentication failed" and HTTP status of forbidden
    */
        try {
            if (verifyToken(cognitoUserPoolId, awsRegion, authorization)) {
                List<FlightDetails> flights = FlightDetailsService.findFlights(departureDate, departureAirportCode, arrivalAirportCode, flightresultsRepository, airportresultsRepository);
                if (flights.size() > 0) {
                    return new ResponseEntity<>(flights.toString(), HttpStatus.OK);
                } else {
                    return new ResponseEntity<>("No flights found", HttpStatus.OK);
                }
            } else {
                return new ResponseEntity<>("Authentication failed", HttpStatus.FORBIDDEN);
            }
        } catch (AuthenticationException e) {
            return e.getResponseEntity();
        }

    }

    /* Create a rest controller bookFlight to get flight details with HTTP POST Method ,
/reserve path and request body reservationDetails. Rest controller returns a ResponseEntity of string.
Authorization token is passed in the header of the request.
*/
    @PostMapping("/reserve")
    public ResponseEntity<String> bookFlight(@RequestBody @Valid ReservationDetails reservationDetails,
                                             @RequestHeader("Authorization") String authorization)
            throws AuthenticationException, FlightNotFoundException, RequestedSeatsNotAvailable {
        ResponseEntity<String> responseEntity = null;
        /*validate the token by calling verifyToken method in a try catch block.
Catch authenticationExceptionHandler exception return the response entity object
from the exception object*/

        try {
            if (verifyToken(cognitoUserPoolId, awsRegion, authorization)) {
                /* create passenger object assign first name, last name and gender of passenger object from reservationDetails object */
                Passenger passenger = new Passenger();
                passenger.setFirstName(reservationDetails.getFirstName());
                passenger.setLastName(reservationDetails.getLastName());
                passenger.setGender(reservationDetails.getGender());
                //Check the age from reservationDetails object and populate adult field
                if (reservationDetails.getAge() >= 18) {
                    passenger.setAdult(true);
                }
                /* create reservation object Assign flightId, travelClass, ticketPrice, currencyCode,contactEmail,
                 contactNumber, reservationStatus, paymentStatus, paymentMode */
                Reservation reservation = new Reservation();
                reservation.setFlightId(reservationDetails.getFlightId());
                reservation.setTravelClass(reservationDetails.getTravelClass());
                reservation.setTicketPrice(reservationDetails.getTicketPrice());
                reservation.setCurrencyCode(reservationDetails.getCurrencyCode());
                reservation.setContactEmail(reservationDetails.getContactEmail());
                reservation.setContactNumber(reservationDetails.getContactNumber());
                reservation.setReservationStatus("Pending");
                reservation.setPaymentStatus("Pending");
                reservation.setPaymentMode("Cash");
                /* set the date reservation date in yyyy-MM-dd format and
                reservation time in HH:mm:ss format for current date and time*/
                reservation.setReservationDate(java.time.LocalDate.now().toString());
                reservation.setReservationTime(java.time.LocalTime.now().toString());

                Boolean result;
                try {
                    int noOfPassengers = 1;
                    Region region = Region.of(awsRegion);
                    result = flightBooking.reserveFlight(passenger, reservation, passengerRepository,
                            reservationRepository, flightresultsRepository, noOfPassengers, snsTopicArn, region);
                }
                catch (FlightNotFoundException e) {
                    return e.getResponseEntity();
                }
                catch (RequestedSeatsNotAvailable e) {
                    return e.getResponseEntity();
                }
                /* check if the reservation is successful
                 return response entity object with HTTP status of ok and
                message "reservation made successfully" appending the booking Reference
                if the reservation is not successful
                return response entity object with HTTP status of bad request */
                if (result) {
                    responseEntity = new ResponseEntity<>("Reservation made successfully. Booking Reference: " + reservation.getBookingReference(), HttpStatus.OK);
                }
                else {
                    responseEntity = new ResponseEntity<>("Reservation failed", HttpStatus.BAD_REQUEST);
                }

            }
        } catch (AuthenticationException e) {
            responseEntity = e.getResponseEntity();
        }
        return responseEntity;
    }
}
```